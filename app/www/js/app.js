// Generated by CoffeeScript 1.8.0

/*
App-o-Mat jQuery Mobile Cordova starter template
https://github.com/app-o-mat/jqm-cordova-template-project
http://app-o-mat.com

MIT License
https://github.com/app-o-mat/jqm-cordova-template-project/LICENSE.md
 */

(function() {
  'use strict';
  var App, appendTo;

  appendTo = function(element, muggexpr) {
    element.append(CoffeeMugg.render(muggexpr, {
      format: false
    })).trigger('create');
  };

  App = (function() {
    function App(readWriteDir, readOnlyDir, remoteURL) {
      this.library = readWriteDir != null ? new Library(readWriteDir) : null;
      this.libraryStatic = readOnlyDir != null ? new Archive(readOnlyDir) : null;
      this.remote = (readWriteDir != null) && (remoteURL != null) ? new Remote(readWriteDir, remoteURL) : null;
      if (readWriteDir == null) {
        $('#clear-button').addClass('ui-state-disabled');
      }
      if (!((readWriteDir != null) && (remoteURL != null))) {
        $('#download-button').addClass('ui-state-disabled');
      }
    }

    App.prototype.onDeviceReady = function() {
      FastClick.attach(document.body);
      this.resizeImage();
      $(window).resize((function(_this) {
        return function() {
          return _this.resizeImage();
        };
      })(this));
      this.refreshLibrary();
      $(document).scroll((function(_this) {
        return function() {
          return _this.checkScroll();
        };
      })(this));
    };

    App.prototype.syncRemote = function(callback) {
      if (callback == null) {
        callback = (function() {});
      }
      $('#remote-content').html('<p>Connecting to server...</p>');
      setTimeout((function(_this) {
        return function() {
          _this.remote.downloadList(function() {
            var dataset, _i, _len, _ref;
            _this.clearRemoteButtons();
            _ref = _this.remote.datasets;
            for (_i = 0, _len = _ref.length; _i < _len; _i++) {
              dataset = _ref[_i];
              _this.addRemoteButton(dataset);
            }
            callback();
          }, function() {
            $('#remote-content').html("<p>Failed to connect.</p>\n<p><a onclick=\"app.syncRemote();\">Try again</a></p>");
          });
        };
      })(this), 250);
    };

    App.prototype.clearRemoteButtons = function() {
      $('#remote-content').text('');
      appendTo($('#remote-content'), function() {
        this.table('#remote-table .guide-table', '');
      });
    };

    App.prototype.addRemoteButton = function(dataset) {
      var setFn;
      setFn = "app.downloadZip($(this), '" + dataset.id + "');";
      appendTo($('#remote-table'), function() {
        this.tr('.guide-button', function() {
          this.td('.guide-icon-box', {
            onclick: setFn
          }, function() {
            var _ref;
            this.img('.guide-icon', {
              src: (_ref = dataset.icon) != null ? _ref : 'img/noimage.png'
            });
          });
          this.td('.guide-text', {
            onclick: setFn
          }, function() {
            this.div('.guide-title', dataset.title);
            this.div('.guide-desc', dataset.description);
          });
        });
        this.tr('.guide-spacer', '');
      });
    };

    App.prototype.downloadZip = function(button, id, callback) {
      var dataset, row, titleOrig, titleText;
      if (callback == null) {
        callback = (function() {});
      }
      dataset = this.remote.getDataset(id);
      row = button.closest('tr');
      titleText = button.parent().find('.guide-title');
      row.addClass('ui-state-disabled');
      titleOrig = titleText.text();
      titleText.text("Downloading: " + titleOrig);
      this.library.makeDir((function(_this) {
        return function() {
          _this.remote.downloadDataset(id, _this.library, function() {
            titleText.text(titleOrig);
            row.removeClass('ui-state-disabled');
            _this.refreshLibrary(callback);
          }, function() {
            setTimeout(function() {
              titleText.text("Failed: " + titleOrig);
              row.removeClass('ui-state-disabled');
            }, 250);
          });
        };
      })(this));
    };

    App.prototype.readyClear = function() {
      $('#confirm-delete-message').text('Are you sure you want to delete all guides?');
      this.deleteAction = (function(_this) {
        return function(callback) {
          _this.clearLibrary(callback);
        };
      })(this);
      $.mobile.changePage('#confirm-delete', {
        transition: 'pop'
      });
    };

    App.prototype.readyDelete = function(id) {
      var title;
      title = this.library.datasets[id].title;
      $('#confirm-delete-message').text("Are you sure you want to delete the \"" + title + "\" guide?");
      this.deleteAction = (function(_this) {
        return function(callback) {
          _this.deleteDataset(id, callback);
        };
      })(this);
      $.mobile.changePage('#confirm-delete', {
        transition: 'pop'
      });
    };

    App.prototype.proceedDelete = function(callback) {
      if (callback == null) {
        callback = (function() {});
      }
      this.deleteAction((function(_this) {
        return function() {
          $.mobile.changePage('#home', {
            transition: 'pop',
            reverse: true
          });
          callback();
        };
      })(this));
    };

    App.prototype.clearLibrary = function(callback) {
      if (callback == null) {
        callback = (function() {});
      }
      this.library.deleteDir((function(_this) {
        return function() {
          _this.refreshLibrary(callback);
        };
      })(this));
    };

    App.prototype.refreshLibrary = function(callback) {
      var scanStatic;
      if (callback == null) {
        callback = (function() {});
      }
      this.clearDataButtons();
      scanStatic = (function(_this) {
        return function() {
          if (_this.libraryStatic != null) {
            _this.libraryStatic.scanLibrary(function() {
              var dataset, id, _ref;
              _ref = _this.libraryStatic.datasets;
              for (id in _ref) {
                dataset = _ref[id];
                _this.addDataButton(dataset, false);
              }
              callback();
            });
          } else {
            callback();
          }
        };
      })(this);
      if (this.library != null) {
        this.library.scanLibrary((function(_this) {
          return function() {
            var dataset, id, _ref;
            _ref = _this.library.datasets;
            for (id in _ref) {
              dataset = _ref[id];
              _this.addDataButton(dataset, true);
            }
            scanStatic();
          };
        })(this));
      } else {
        scanStatic();
      }
    };

    App.prototype.deleteDataset = function(id, callback) {
      if (callback == null) {
        callback = (function() {});
      }
      this.library.deleteSet(id, (function(_this) {
        return function() {
          _this.refreshLibrary(callback);
        };
      })(this));
    };

    App.prototype.clearDataButtons = function() {
      $('#home-table').text('');
    };

    App.prototype.addDataButton = function(dataset, canDelete) {
      var deleteFn, setFn;
      setFn = "app.goToDataset('" + dataset.id + "');";
      deleteFn = "app.readyDelete('" + dataset.id + "');";
      appendTo($('#home-table'), function() {
        this.tr('.guide-button', function() {
          this.td('.guide-icon-box', {
            onclick: setFn
          }, function() {
            var _ref;
            this.img('.guide-icon', {
              src: (_ref = dataset.icon) != null ? _ref : 'img/noimage.png'
            });
          });
          this.td('.guide-text', {
            onclick: setFn
          }, function() {
            this.div('.guide-title', dataset.title);
            this.div('.guide-desc', dataset.description);
          });
          if (canDelete) {
            this.td('.guide-delete', {
              onclick: deleteFn
            }, 'Delete');
          }
        });
        this.tr('.guide-spacer', '');
      });
    };

    App.prototype.goToDataset = function(id, callback) {
      if (callback == null) {
        callback = (function() {});
      }
      this.setDataset(id, (function(_this) {
        return function() {
          $.mobile.changePage($('#dataset'));
          callback();
        };
      })(this));
    };

    App.prototype.setDataset = function(id, callback) {
      var _ref, _ref1, _ref2;
      if (callback == null) {
        callback = (function() {});
      }
      this.dataset = (_ref = (_ref1 = this.library) != null ? _ref1.datasets[id] : void 0) != null ? _ref : (_ref2 = this.libraryStatic) != null ? _ref2.datasets[id] : void 0;
      this.dataset.load((function(_this) {
        return function() {
          var feature, naturalSort, value, values;
          naturalSort = function(a, b) {
            var anum, arest, bnum, brest, matchNum, __, _ref3, _ref4, _ref5, _ref6;
            matchNum = function(x) {
              return x.toString().match(/^([0-9]+)(.*)$/);
            };
            _ref4 = (_ref3 = matchNum(a)) != null ? _ref3 : [null, Infinity, a], __ = _ref4[0], anum = _ref4[1], arest = _ref4[2];
            _ref6 = (_ref5 = matchNum(b)) != null ? _ref5 : [null, Infinity, b], __ = _ref6[0], bnum = _ref6[1], brest = _ref6[2];
            if (anum === bnum) {
              return arest.localeCompare(brest);
            } else {
              return anum - bnum;
            }
          };
          _this.featureRows = (function() {
            var _ref3, _results;
            _ref3 = this.dataset.features;
            _results = [];
            for (feature in _ref3) {
              values = _ref3[feature];
              _results.push((function() {
                var _i, _len, _ref4, _ref5, _results1;
                _ref4 = Object.keys(values).sort(naturalSort);
                _results1 = [];
                for (_i = 0, _len = _ref4.length; _i < _len; _i++) {
                  value = _ref4[_i];
                  _results1.push({
                    display: displayValue(value),
                    image: (_ref5 = this.dataset.imageForFeature(feature, value)) != null ? _ref5 : 'img/noimage.png',
                    feature: feature,
                    value: value
                  });
                }
                return _results1;
              }).call(this));
            }
            return _results;
          }).call(_this);
          $('#dataset-header').text(_this.dataset.title);
          _this.makeFeatureRows();
          _this.showHowMany();
          _this.fillLikelyPage();
          callback();
        };
      })(this));
    };

    App.prototype.makeFeatureRows = function() {
      var feature, row, _i, _len, _ref;
      $('#dataset-entries').text('');
      _ref = this.featureRows;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        row = _ref[_i];
        feature = row[0].feature;
        appendTo($('#dataset-entries'), function() {
          this.div('.feature-row', function() {
            this.div('.feature-name', displayValue(feature));
            this.div('.feature-boxes', function() {
              var display, image, toggleFn, value, _j, _len1, _ref1;
              for (_j = 0, _len1 = row.length; _j < _len1; _j++) {
                _ref1 = row[_j], display = _ref1.display, image = _ref1.image, value = _ref1.value;
                toggleFn = "app.toggleElement(this, '" + feature + "', '" + value + "');";
                this.div('.feature-box', {
                  onclick: toggleFn
                }, function() {
                  this.div('.feature-img-box', function() {
                    this.img('.feature-img', {
                      src: image
                    });
                  });
                  this.div('.feature-value', display);
                });
              }
            });
          });
        });
      }
      this.selected = {};
      $('.feature-value').removeClass('selected');
    };

    App.prototype.toggleElement = function(element, feature, value) {
      var _base;
      if ((_base = this.selected)[feature] == null) {
        _base[feature] = {};
      }
      if (this.selected[feature][value]) {
        delete this.selected[feature][value];
        $(element).removeClass('selected');
      } else {
        this.selected[feature][value] = true;
        $(element).addClass('selected');
      }
      if (Object.keys(this.selected[feature]).length === 0) {
        delete this.selected[feature];
      }
      this.showHowMany();
      this.fillLikelyPage();
    };

    App.prototype.showHowMany = function() {
      $('#how-many-likely').text(this.getLikely().length);
    };

    App.prototype.getLikely = function() {
      var cutoff, maxScore, spec, __, _ref, _results;
      maxScore = Object.keys(this.selected).length;
      cutoff = maxScore;
      _ref = this.dataset.species;
      _results = [];
      for (__ in _ref) {
        spec = _ref[__];
        if (spec.computeScore(this.selected) >= cutoff) {
          _results.push(spec);
        }
      }
      return _results;
    };

    App.prototype.fillLikelyPage = function() {
      var maxScore, score, spec, species, __;
      $('#likely-col1').text('');
      $('#likely-col2').text('');
      $('#other-col1').text('');
      $('#other-col2').text('');
      species = (function() {
        var _ref, _results;
        _ref = this.dataset.species;
        _results = [];
        for (__ in _ref) {
          spec = _ref[__];
          _results.push([spec, spec.computeScore(this.selected)]);
        }
        return _results;
      }).call(this);
      maxScore = Object.keys(this.selected).length;
      if (maxScore > 0) {
        species = (function() {
          var _i, _len, _ref, _results;
          _results = [];
          for (_i = 0, _len = species.length; _i < _len; _i++) {
            _ref = species[_i], spec = _ref[0], score = _ref[1];
            if (score > 0) {
              _results.push([spec, score]);
            }
          }
          return _results;
        })();
        species.sort(function(_arg, _arg1) {
          var score1, score2, spec1, spec2;
          spec1 = _arg[0], score1 = _arg[1];
          spec2 = _arg1[0], score2 = _arg1[1];
          return score2 - score1;
        });
      }
      this.speciesPending = species;
      this.showSpecies();
      this.nextLikelyCol = 1;
      this.nextOtherCol = 1;
    };

    App.prototype.checkScroll = function() {
      if (document.URL.match(/\#likely$/) != null) {
        if ($(window).height() + $(document).scrollTop() >= $(document).height() - 50) {
          this.showSpecies();
          setTimeout((function(_this) {
            return function() {
              _this.checkScroll();
            };
          })(this), 0);
        }
      }
    };

    App.prototype.showSpecies = function() {
      var dataset, div, maxScore, s, score, spec, toShow, _i, _j, _len, _len1, _ref, _ref1;
      if (this.speciesPending.length === 0) {
        return;
      }
      toShow = this.speciesPending.slice(0, 10);
      this.speciesPending = this.speciesPending.slice(10);
      dataset = this.dataset;
      maxScore = Object.keys(this.selected).length;
      for (_i = 0, _len = toShow.length; _i < _len; _i++) {
        _ref = toShow[_i], spec = _ref[0], score = _ref[1];
        div = score === maxScore ? (s = "#likely-col" + this.nextLikelyCol, this.nextLikelyCol = this.nextLikelyCol === 2 ? 1 : 2, s) : (s = "#other-col" + this.nextOtherCol, this.nextOtherCol = this.nextOtherCol === 2 ? 1 : 2, s);
        appendTo($(div), function() {
          var setFn;
          setFn = "app.setSpecies('" + spec.name + "'); return true;";
          this.a('.to-species', {
            href: '#specimen0',
            'data-transition': 'slide',
            onclick: setFn
          }, function() {
            this.div('.feature-box', function() {
              this.div('.feature-img-box', function() {
                var image, part, pics, _ref1;
                pics = dataset.imagesForSpecies(spec);
                if (pics.length === 0) {
                  this.img('.feature-img', {
                    src: 'img/noimage.png'
                  });
                } else {
                  _ref1 = pics[0], part = _ref1[0], image = _ref1[1];
                  this.img('.feature-img', {
                    src: image
                  });
                }
              });
              this.div('.feature-value', function() {
                this.text("" + spec.display_name + " (" + score + ")");
              });
            });
          });
        });
      }
      _ref1 = ['#likely-col1', '#other-col1'];
      for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
        div = _ref1[_j];
        if ($(div).html() === '') {
          $("" + div + "-section").hide();
        } else {
          $("" + div + "-section").show();
        }
      }
    };

    App.prototype.setSpecies = function(name) {
      var image, ix, part, pics, spec, _i, _len, _ref;
      this.clearPages();
      spec = this.dataset.species[name];
      pics = this.dataset.imagesForSpecies(spec);
      if (pics.length === 0) {
        this.addPage(spec.display_name, 'img/noimage.png', spec.description, 0);
      } else {
        for (ix = _i = 0, _len = pics.length; _i < _len; ix = ++_i) {
          _ref = pics[ix], part = _ref[0], image = _ref[1];
          this.addPage(spec.display_name, image, spec.description, ix);
        }
      }
      this.resizeImage();
      this.addSwipes(pics.length);
    };

    App.prototype.clearPages = function() {
      var i, page;
      i = 0;
      while (true) {
        page = $("#specimen" + i);
        if (page.length === 0) {
          return;
        }
        page.remove();
        i++;
      }
    };

    App.prototype.addPage = function(name, img, desc, ix) {
      img = encodeURI(img);
      appendTo($('body'), function() {
        this.div("#specimen" + ix + " .specimen", {
          'data-role': 'page'
        }, function() {
          this.div('.dataset-navbar', function() {
            this.a('.dataset-nav-left', {
              href: '#likely',
              'data-transition': 'slide',
              'data-direction': 'reverse'
            }, function() {
              this.span('.dataset-nav-arrow', '<');
              this.text(' Back');
            });
            this.div('.dataset-nav-center', '');
            this.div('.dataset-nav-right', '');
          });
          this.div('.ui-content .specimen-content', {
            'data-role': 'main'
          }, function() {
            this.div('.specimen-img-box', function() {
              this.div('.specimen-img', {
                style: "background-image: url(" + img + ");"
              }, '');
              this.div('.specimen-img .blur', {
                style: "background-image: url(" + img + ");"
              }, '');
              this.div('.specimen-img-gradient', '');
            });
            this.div('.specimen-text-box', function() {
              this.div('.specimen-text', function() {
                this.h1(name);
                this.text(desc);
              });
            });
          });
        });
      });
    };

    App.prototype.addSwipes = function(imgs) {
      var ix, _fn, _fn1, _i, _j, _ref, _ref1;
      if (imgs >= 2) {
        _fn = function(ix) {
          $("#specimen" + ix + " .specimen-img-box").on('swipeleft', function() {
            $.mobile.changePage("#specimen" + (ix + 1), {
              transition: "slide"
            });
          });
        };
        for (ix = _i = 0, _ref = imgs - 2; 0 <= _ref ? _i <= _ref : _i >= _ref; ix = 0 <= _ref ? ++_i : --_i) {
          _fn(ix);
        }
        _fn1 = function(ix) {
          $("#specimen" + ix + " .specimen-img-box").on('swiperight', function() {
            $.mobile.changePage("#specimen" + (ix - 1), {
              transition: "slide",
              reverse: true
            });
          });
        };
        for (ix = _j = 1, _ref1 = imgs - 1; 1 <= _ref1 ? _j <= _ref1 : _j >= _ref1; ix = 1 <= _ref1 ? ++_j : --_j) {
          _fn1(ix);
        }
      }
    };

    App.prototype.resizeImage = function() {
      var h;
      h = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
      $('.specimen-img-box').css('height', "" + (h - 160) + "px");
    };

    return App;

  })();

  window.App = App;

}).call(this);
