// Generated by CoffeeScript 1.8.0
(function() {
  'use strict';
  var Dataset, datasetDisplay;

  Dataset = (function() {
    function Dataset(dir) {
      this.dir = dir;
    }

    Dataset.prototype.load = function(callback) {
      console.log('Loading dataset info...');
      this.loadInfo((function(_this) {
        return function() {
          console.log('Loading species data...');
          _this.loadSpeciesData(function() {
            console.log('Loading feature images...');
            _this.loadFeatureImages(function() {
              console.log('Loading species images...');
              _this.loadSpeciesImages(function() {
                console.log('Done loading!');
                callback();
              });
            });
          });
        };
      })(this));
    };

    Dataset.prototype.loadInfo = function(callback) {
      $.getJSON("" + this.dir + "/info.json", (function(_this) {
        return function(json) {
          _this.title = json.title, _this.id = json.id, _this.version = json.version, _this.description = json.description, _this.author = json.author, _this.icon = json.icon;
          if (_this.icon) {
            _this.icon = resolveURI("" + _this.dir + "/", _this.icon);
          }
          callback();
        };
      })(this));
    };

    Dataset.prototype.loadDirectory = function(json, dir, callback) {
      getJSONList(json, callback, (function(_this) {
        return function() {
          resolveLocalFileSystemURL(dir, function(dirEntry) {
            getAllFiles(dirEntry.createReader(), function(entries) {
              var entry, urls;
              urls = (function() {
                var _i, _len, _results;
                _results = [];
                for (_i = 0, _len = entries.length; _i < _len; _i++) {
                  entry = entries[_i];
                  _results.push(entry.toURL());
                }
                return _results;
              })();
              callback(urls);
            });
          }, function() {
            console.log("Tried to load from nonexistent folder: " + dir);
            callback([]);
          });
        };
      })(this));
    };

    Dataset.prototype.loadFeatureImages = function(callback) {
      this.featureImages = {};
      this.loadDirectory("" + this.dir + "/features.json", "" + this.dir + "/features/", (function(_this) {
        return function(images) {
          var image, _i, _len;
          for (_i = 0, _len = images.length; _i < _len; _i++) {
            image = images[_i];
            _this.addFeatureImage(image);
          }
          callback();
        };
      })(this));
    };

    Dataset.prototype.loadSpeciesImages = function(callback) {
      this.speciesImages = {};
      this.loadDirectory("" + this.dir + "/species.json", "" + this.dir + "/species/", (function(_this) {
        return function(images) {
          var image, _i, _len;
          for (_i = 0, _len = images.length; _i < _len; _i++) {
            image = images[_i];
            _this.addSpeciesImage(image);
          }
          callback();
        };
      })(this));
    };

    Dataset.prototype.addFeatureImage = function(url) {
      var feature, result, value, _base;
      url = decodeURI(url);
      if (url.match(/\.DS_Store$/)) {
        return;
      }
      result = url.match(/(?:^|\/)([\w \-]+)\/([\w \-]+)\.\w+$/);
      if (result != null) {
        feature = comparisonValue(result[1]);
        value = comparisonValue(result[2]);
        if ((_base = this.featureImages)[feature] == null) {
          _base[feature] = {};
        }
        this.featureImages[feature][value] = url;
        return;
      }
      console.log("Couldn't parse feature image: " + url);
    };

    Dataset.prototype.addSpeciesImage = function(url) {
      var img, index, label, name, result, _base, _i, _ref;
      url = decodeURI(url);
      if (url.match(/\.DS_Store$/)) {
        return;
      }
      result = url.match(/(?:^|\/)([^\.\/]+)(\.\w+)?$/);
      if (result != null) {
        img = comparisonValue(result[1]);
        for (index = _i = _ref = img.length; _ref <= 0 ? _i <= 0 : _i >= 0; index = _ref <= 0 ? ++_i : --_i) {
          name = img.slice(0, +index + 1 || 9e9);
          if (this.species[name] != null) {
            label = img.slice(index);
            if ((_base = this.speciesImages)[name] == null) {
              _base[name] = [];
            }
            this.speciesImages[name].push([label, url]);
            return;
          }
        }
      }
      console.log("Couldn't parse species image: " + url);
    };

    Dataset.prototype.loadSpeciesData = function(callback) {
      $.get("" + this.dir + "/species.csv", (function(_this) {
        return function(str) {
          var csvRow, spec, _i, _len, _ref;
          _this.species = {};
          _ref = $.parse(str).results.rows;
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            csvRow = _ref[_i];
            spec = new Species(csvRow);
            _this.species[comparisonValue(spec.name)] = spec;
          }
          _this.listFeatures();
          callback();
        };
      })(this));
    };

    Dataset.prototype.listFeatures = function() {
      var feature, k, spec, value, values, _base, _i, _len, _ref, _ref1;
      this.features = {};
      _ref = this.species;
      for (k in _ref) {
        spec = _ref[k];
        _ref1 = spec.features;
        for (feature in _ref1) {
          values = _ref1[feature];
          if ((_base = this.features)[feature] == null) {
            _base[feature] = {};
          }
          for (_i = 0, _len = values.length; _i < _len; _i++) {
            value = values[_i];
            this.features[feature][value] = true;
          }
        }
      }
    };

    Dataset.prototype.featureDisplayName = function(feature) {
      var k, name, spec, vs, _ref, _ref1;
      _ref = this.species;
      for (name in _ref) {
        spec = _ref[name];
        _ref1 = spec.csvRow;
        for (k in _ref1) {
          vs = _ref1[k];
          if (feature === comparisonValue(k)) {
            return k.split('_').join(' ');
          }
        }
      }
    };

    Dataset.prototype.valueDisplayName = function(value) {
      var k, name, spec, v, vs, _i, _len, _ref, _ref1, _ref2;
      _ref = this.species;
      for (name in _ref) {
        spec = _ref[name];
        _ref1 = spec.csvRow;
        for (k in _ref1) {
          vs = _ref1[k];
          _ref2 = splitList(vs);
          for (_i = 0, _len = _ref2.length; _i < _len; _i++) {
            v = _ref2[_i];
            if (value === comparisonValue(v)) {
              return v.split('_').join(' ');
            }
          }
        }
      }
    };

    Dataset.prototype.imagesForSpecies = function(spec) {
      var imgs, _ref;
      imgs = (_ref = this.speciesImages[comparisonValue(spec.name)]) != null ? _ref : [];
      imgs.sort(function(_arg, _arg1) {
        var label1, label2, url1, url2;
        label1 = _arg[0], url1 = _arg[1];
        label2 = _arg1[0], url2 = _arg1[1];
        return label1.localeCompare(label2);
      });
      return imgs;
    };

    Dataset.prototype.imageForFeature = function(feature, value) {
      var _ref;
      return ((_ref = this.featureImages[comparisonValue(feature)]) != null ? _ref : {})[comparisonValue(value)];
    };

    return Dataset;

  })();

  datasetDisplay = function(obj) {
    return "" + obj.title + " v" + obj.version;
  };

  window.Dataset = Dataset;

  window.datasetDisplay = datasetDisplay;

}).call(this);
